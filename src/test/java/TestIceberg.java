import org.junit.jupiter.api.Test;
import static org.junit.jupiter.api.Assertions.assertEquals;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.MethodSource;
import org.junit.jupiter.params.provider.Arguments;
import java.nio.charset.StandardCharsets;
import java.io.InputStream;
import java.io.PrintStream;
import java.io.ByteArrayOutputStream;
import java.io.ByteArrayInputStream;
import java.util.stream.Stream;
import java.io.IOException;


/**
 * End 2 End Tests for the Iceberg orders.
 */

public class TestIceberg {
  
    @ParameterizedTest
    @MethodSource("icebergTestsProvider")
    public void runTest(String testId, String input, String expectedOutput) throws IOException {

        String stdOut = getOrderBookOutput(input);

        assertEquals(expectedOutput, stdOut);
    }

    private static String getOrderBookOutput(String input) throws IOException {
        InputStream oldIn = System.in;
        PrintStream oldOut = System.out;

        try (
            ByteArrayInputStream newIn = new ByteArrayInputStream(input.getBytes());
            ByteArrayOutputStream baos = new ByteArrayOutputStream();
            PrintStream ps = new PrintStream(baos, true)
        ){
            System.setIn(newIn);
            System.setOut(ps);

            SETSOrderBookExercise.main(new String[0]);

            return baos.toString(StandardCharsets.UTF_8.name()).trim().replaceAll("\\r\\n?", "\n");

        } finally {
            System.setIn(oldIn);
            System.setOut(oldOut);
        }
    }

    static Stream<Arguments> icebergTestsProvider() {
        return Stream.of(
            Arguments.of("IcebergExecution", 
                ""
                .concat("B,1,100,50,20\n")
                .concat("S,2,100,20\n")
                .concat("S,3,100,10"),
                ""
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         1|           20|    100|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("1,2,100,20\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         1|           20|    100|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("1,3,100,10\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         1|           10|    100|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+")
            ),
            Arguments.of("IcebergPriorityLoss", 
                ""
                .concat("B,1,100,50,20\n")
                .concat("B,2,100,10\n")
                .concat("S,3,100,20\n")
                .concat("S,4,100,10"),
                ""
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         1|           20|    100|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         1|           20|    100|       |             |          |\n")
                .concat("|         2|           10|    100|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("1,3,100,20\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         2|           10|    100|       |             |          |\n")
                .concat("|         1|           20|    100|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("2,4,100,10\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         1|           20|    100|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+")
            ),
            Arguments.of("AggressiveIcebergPeakReset",
                ""
                .concat("S,1,100,15\n")
                .concat("B,2,100,100,10"),
                ""
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|          |             |       |    100|           15|         1|\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("2,1,100,15\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         2|           10|    100|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+")
            ), // Test cases from the LSE document
            Arguments.of("AggressiveIcebergOrderEntry",
                ""
                .concat("B,1,99,50000\n")
                .concat("B,2,98,25500\n")
                .concat("S,3,100,10000\n")
                .concat("S,4,100,7500\n")
                .concat("S,5,101,20000\n")
                .concat("B,6,100,100000,10000"),
                ""
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         1|       50,000|     99|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         1|       50,000|     99|       |             |          |\n")
                .concat("|         2|       25,500|     98|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         1|       50,000|     99|    100|       10,000|         3|\n")
                .concat("|         2|       25,500|     98|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         1|       50,000|     99|    100|       10,000|         3|\n")
                .concat("|         2|       25,500|     98|    100|        7,500|         4|\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         1|       50,000|     99|    100|       10,000|         3|\n")
                .concat("|         2|       25,500|     98|    100|        7,500|         4|\n")
                .concat("|          |             |       |    101|       20,000|         5|\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("6,3,100,10000\n")
                .concat("6,4,100,7500\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         6|       10,000|    100|    101|       20,000|         5|\n")
                .concat("|         1|       50,000|     99|       |             |          |\n")
                .concat("|         2|       25,500|     98|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+")
            ),
            Arguments.of("PassiveIcebergOrderExecution",
                ""
                .concat("B,1,99,50000\n")
                .concat("B,2,98,25500\n")
                .concat("S,5,101,20000\n")
                .concat("B,6,100,82500,10000\n")
                .concat("S,7,100,10000\n")
                .concat("S,8,100,11000"),
                ""
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         1|       50,000|     99|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         1|       50,000|     99|       |             |          |\n")
                .concat("|         2|       25,500|     98|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         1|       50,000|     99|    101|       20,000|         5|\n")
                .concat("|         2|       25,500|     98|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         6|       10,000|    100|    101|       20,000|         5|\n")
                .concat("|         1|       50,000|     99|       |             |          |\n")
                .concat("|         2|       25,500|     98|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("6,7,100,10000\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         6|       10,000|    100|    101|       20,000|         5|\n")
                .concat("|         1|       50,000|     99|       |             |          |\n")
                .concat("|         2|       25,500|     98|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("6,8,100,11000\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         6|        9,000|    100|    101|       20,000|         5|\n")
                .concat("|         1|       50,000|     99|       |             |          |\n")
                .concat("|         2|       25,500|     98|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+")
            ),
            Arguments.of("MultipleIcebergExecution",
                ""
                .concat("S,3,100,10000\n")
                .concat("S,4,100,7500\n")
                .concat("S,5,101,20000\n")
                .concat("B,1,99,50000\n")
                .concat("B,6,100,100000,10000\n")
                .concat("S,102,100,10000\n")
                .concat("S,103,100,11000\n")
                .concat("B,7,100,50000,20000\n")
                .concat("S,8,100,35000"),
                ""
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|          |             |       |    100|       10,000|         3|\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|          |             |       |    100|       10,000|         3|\n")
                .concat("|          |             |       |    100|        7,500|         4|\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|          |             |       |    100|       10,000|         3|\n")
                .concat("|          |             |       |    100|        7,500|         4|\n")
                .concat("|          |             |       |    101|       20,000|         5|\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         1|       50,000|     99|    100|       10,000|         3|\n")
                .concat("|          |             |       |    100|        7,500|         4|\n")
                .concat("|          |             |       |    101|       20,000|         5|\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("6,3,100,10000\n")
                .concat("6,4,100,7500\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         6|       10,000|    100|    101|       20,000|         5|\n")
                .concat("|         1|       50,000|     99|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("6,102,100,10000\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         6|       10,000|    100|    101|       20,000|         5|\n")
                .concat("|         1|       50,000|     99|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("6,103,100,11000\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         6|        9,000|    100|    101|       20,000|         5|\n")
                .concat("|         1|       50,000|     99|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         6|        9,000|    100|    101|       20,000|         5|\n")
                .concat("|         7|       20,000|    100|       |             |          |\n")
                .concat("|         1|       50,000|     99|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("6,8,100,15000\n")
                .concat("7,8,100,20000\n")
                .concat("+-----------------------------------------------------------------+\n")
                .concat("| BUY                            | SELL                           |\n")
                .concat("| Id       | Volume      | Price | Price | Volume      | Id       |\n")
                .concat("+----------+-------------+-------+-------+-------------+----------+\n")
                .concat("|         6|        4,000|    100|    101|       20,000|         5|\n")
                .concat("|         7|       20,000|    100|       |             |          |\n")
                .concat("|         1|       50,000|     99|       |             |          |\n")
                .concat("+-----------------------------------------------------------------+")
            )
        );
    }
}
